{% extends "base.html" %} {% block content %}
<h2>Lehrkr√§fte</h2>

<p><a href="/admin">CSV hochladen</a></p>

<form method="post" action="/admin/teachers/bulk">
    <div style="margin: .5rem 0;">
        <button type="submit" name="action" value="set_exempt">Als ‚Äûkeine Aufsicht" markieren</button>
        <button type="submit" name="action" value="unset_exempt">‚ÄûKeine Aufsicht" entfernen</button>
    </div>

    <div style="margin: .5rem 0;">
        <input type="number" name="target_duties" min="0" placeholder="Soll-Aufsicht" style="width:8rem">
        <button type="submit" formaction="/admin/teachers/bulk-quota" formmethod="post">Soll (Masse) setzen</button>
    </div>

    <div style="margin: .5rem 0; padding: .5rem; background: #f0f0f0; border-radius: 5px;">
        <strong>Anwesenheitstage (Masse):</strong>
        <label style="margin-left: 10px;"><input type="checkbox" name="bulk_days" value="Mo" checked> Mo</label>
        <label style="margin-left: 10px;"><input type="checkbox" name="bulk_days" value="Di" checked> Di</label>
        <label style="margin-left: 10px;"><input type="checkbox" name="bulk_days" value="Mi" checked> Mi</label>
        <label style="margin-left: 10px;"><input type="checkbox" name="bulk_days" value="Do" checked> Do</label>
        <label style="margin-left: 10px;"><input type="checkbox" name="bulk_days" value="Fr" checked> Fr</label>
        <button type="submit" formaction="/admin/teachers/bulk-attendance" formmethod="post" style="margin-left: 15px;">Anwesenheitstage (Masse) setzen</button>
    </div>

    <table>
        <thead>
            <tr>
                <th style="width:2rem;"><input type="checkbox" onclick="document.querySelectorAll('input[name=ids]').forEach(cb=>cb.checked=this.checked)"></th>
                <th>K√ºrzel</th>
                <th>Nachname</th>
                <th>Vorname</th>
                <th>Keine Aufsicht</th>
                <th>Soll</th>
                <th>Bevorzugtes Stockwerk</th>
                <th>Anwesenheitstage</th>
                <th>Aktionen</th>
            </tr>
        </thead>
        <tbody>
            {% for t in teachers %}
            <tr>
                <td><input type="checkbox" name="ids" value="{{ t.id }}"></td>
                <td>{{ t.abbreviation }}</td>
                <td>{{ t.last_name }}</td>
                <td>{{ t.first_name }}</td>
                <td>
                    <form method="post" action="/admin/teachers/set-exempt" style="display:inline;">
                        <input type="hidden" name="teacher_id" value="{{ t.id }}">
                        <input type="checkbox" name="exempt" value="true" onchange="this.form.submit()" {% if t.exempt %}checked{% endif %}>
                    </form>
                </td>
                <td>
                    <form method="post" action="/admin/teachers/set-quota" style="display:inline;">
                        <input type="hidden" name="teacher_id" value="{{ t.id }}">
                        <input type="number" name="target_duties" min="0" value="{{ t.quota.target_duties if t.quota else 0 }}" style="width:4rem">
                        <button type="submit">Set</button>
                    </form>
                </td>
                <td>
                    <form method="post" action="/admin/teachers/set-preferred-floor" style="display:inline;">
                        <input type="hidden" name="teacher_id" value="{{ t.id }}">
                        <select name="preferred_floor_id" onchange="this.form.submit()">
                            <option value="">Keine Pr√§ferenz</option>
                            {% for floor in floors %}
                            <option value="{{ floor.id }}" {% if t.preferred_floor_id == floor.id %}selected{% endif %}>{{ floor.name }}</option>
                            {% endfor %}
                        </select>
                    </form>
                </td>
                <td style="font-size: 0.8em;">
                    <div id="attendance_display_{{ t.id }}">
                        {% if t.attendance_days == 31 %}
                        <span style="color: green;">{{ t.get_attendance_days_display() }}</span> {% elif t.attendance_days %}
                        <span style="color: orange;">{{ t.get_attendance_days_display() }}</span> {% else %}
                        <span style="color: red;">Keine</span> {% endif %}
                        <a href="#" onclick="showAttendanceEdit({{ t.id }}); return false;" style="margin-left: 8px; font-size: 0.8em;">‚úèÔ∏è</a>
                    </div>
                    <div id="attendance_edit_{{ t.id }}" style="display:none;">
                        <form method="post" action="/admin/teachers/set-attendance" style="margin: 0;">
                            <input type="hidden" name="teacher_id" value="{{ t.id }}"> {% set active_days = t.get_attendance_days_list() %}
                            <div style="display: flex; flex-wrap: wrap; gap: 2px; margin-bottom: 4px;">
                                <label style="font-size: 0.7em;"><input type="checkbox" name="attendance_days" value="Mo" {% if "Mo" in active_days %}checked{% endif %}> Mo</label>
                                <label style="font-size: 0.7em;"><input type="checkbox" name="attendance_days" value="Di" {% if "Di" in active_days %}checked{% endif %}> Di</label>
                                <label style="font-size: 0.7em;"><input type="checkbox" name="attendance_days" value="Mi" {% if "Mi" in active_days %}checked{% endif %}> Mi</label>
                                <label style="font-size: 0.7em;"><input type="checkbox" name="attendance_days" value="Do" {% if "Do" in active_days %}checked{% endif %}> Do</label>
                                <label style="font-size: 0.7em;"><input type="checkbox" name="attendance_days" value="Fr" {% if "Fr" in active_days %}checked{% endif %}> Fr</label>
                            </div>
                            <button type="submit" style="font-size: 0.8em;">üíæ</button>
                            <button type="button" onclick="hideAttendanceEdit({{ t.id }}); return false;" style="font-size: 0.8em;">‚ùå</button>
                        </form>
                    </div>
                </td>
                <td>
                    <form method="post" action="/admin/teachers/delete" style="display:inline;" onsubmit="return confirm('Lehrkraft {{ t.first_name }} {{ t.last_name }} wirklich l√∂schen?');">
                        <input type="hidden" name="teacher_id" value="{{ t.id }}">
                        <button type="submit">L√∂schen</button>
                    </form>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="9">Noch keine Lehrkr√§fte vorhanden.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</form>

<script>
    function showAttendanceEdit(teacherId) {
        document.getElementById('attendance_display_' + teacherId).style.display = 'none';
        document.getElementById('attendance_edit_' + teacherId).style.display = 'block';
    }

    function hideAttendanceEdit(teacherId) {
        document.getElementById('attendance_display_' + teacherId).style.display = 'block';
        document.getElementById('attendance_edit_' + teacherId).style.display = 'none';
    }
</script>

{% endblock %}