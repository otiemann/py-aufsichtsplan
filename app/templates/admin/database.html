{% extends "base.html" %} {% block content %}
<h2>Datenbank-Verwaltung</h2>

<div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem; border-left: 4px solid #007bff;">
    <h3 style="margin-top: 0; color: #2c3e50;">ğŸ“Š Datenbank-Informationen</h3>
    <table style="width: 100%; margin: 0;">
        <tr>
            <td style="border: none; padding: 0.5rem 1rem 0.5rem 0; font-weight: bold;">Speicherort:</td>
            <td style="border: none; padding: 0.5rem 0; font-family: monospace; font-size: 0.9rem;">{{ db_path }}</td>
        </tr>
        <tr>
            <td style="border: none; padding: 0.5rem 1rem 0.5rem 0; font-weight: bold;">Status:</td>
            <td style="border: none; padding: 0.5rem 0;">
                {% if db_exists %}
                <span style="color: #27ae60; font-weight: bold;">âœ… Vorhanden</span> {% else %}
                <span style="color: #e74c3c; font-weight: bold;">âŒ Nicht gefunden</span> {% endif %}
            </td>
        </tr>
        <tr>
            <td style="border: none; padding: 0.5rem 1rem 0.5rem 0; font-weight: bold;">GrÃ¶ÃŸe:</td>
            <td style="border: none; padding: 0.5rem 0;">{{ db_size }}</td>
        </tr>
        <tr>
            <td style="border: none; padding: 0.5rem 1rem 0.5rem 0; font-weight: bold;">Letzte Ã„nderung:</td>
            <td style="border: none; padding: 0.5rem 0;">{{ db_modified }}</td>
        </tr>
    </table>
</div>

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
    <!-- Backup Sektion -->
    <div style="background: #e8f5e8; padding: 1.5rem; border-radius: 8px; border-left: 4px solid #27ae60;">
        <h3 style="margin-top: 0; color: #27ae60;">ğŸ’¾ Datenbank-Backup</h3>
        <p style="margin-bottom: 1.5rem; color: #555;">
            Laden Sie eine Sicherungskopie Ihrer Datenbank herunter. Diese Datei enthÃ¤lt alle LehrkrÃ¤fte, Stockwerke und AufsichtsplÃ¤ne.
        </p>
        <a href="/backup/download" style="display: inline-block; padding: 0.8rem 1.5rem; background: #27ae60; color: white; text-decoration: none; border-radius: 5px; font-weight: bold;">
            ğŸ“¥ Backup herunterladen
        </a>
    </div>

    <!-- Restore Sektion -->
    <div style="background: #fff3cd; padding: 1.5rem; border-radius: 8px; border-left: 4px solid #ffc107;">
        <h3 style="margin-top: 0; color: #856404;">ğŸ”„ Datenbank wiederherstellen</h3>
        <p style="margin-bottom: 1.5rem; color: #555;">
            Stellen Sie Ihre Datenbank aus einer Backup-Datei wieder her. <strong>Achtung:</strong> Dies Ã¼berschreibt alle aktuellen Daten!
        </p>
        <form id="restoreForm" enctype="multipart/form-data" style="margin: 0;">
            <div style="margin-bottom: 1rem;">
                <input type="file" id="backupFile" name="file" accept=".db" required style="width: 100%; padding: 0.5rem; border: 2px dashed #ffc107; border-radius: 5px; background: #fff;">
            </div>
            <button type="button" onclick="restoreDatabase()" style="padding: 0.8rem 1.5rem; background: #ffc107; color: #856404; border: none; border-radius: 5px; font-weight: bold; cursor: pointer;">
                ğŸ“¤ Datenbank wiederherstellen
            </button>
        </form>
    </div>
</div>

<div style="background: #f8d7da; padding: 1.5rem; border-radius: 8px; border-left: 4px solid #dc3545;">
    <h3 style="margin-top: 0; color: #721c24;">âš ï¸ Wichtige Hinweise</h3>
    <ul style="margin: 0; color: #721c24;">
        <li><strong>Backup vor Restore:</strong> Erstellen Sie immer ein Backup vor der Wiederherstellung</li>
        <li><strong>KompatibilitÃ¤t:</strong> Verwenden Sie nur Backup-Dateien aus derselben Anwendungsversion</li>
        <li><strong>Datenverlust:</strong> Bei der Wiederherstellung gehen alle aktuellen Daten verloren</li>
        <li><strong>Neustart:</strong> Nach der Wiederherstellung sollten Sie die Anwendung neu starten</li>
    </ul>
</div>

<script>
    async function restoreDatabase() {
        const fileInput = document.getElementById('backupFile');
        const file = fileInput.files[0];

        if (!file) {
            alert('âŒ Bitte wÃ¤hlen Sie eine Backup-Datei aus.');
            return;
        }

        if (!file.name.endsWith('.db')) {
            alert('âŒ Bitte wÃ¤hlen Sie eine gÃ¼ltige .db-Datei aus.');
            return;
        }

        const confirmed = confirm(
            'âš ï¸ ACHTUNG: Diese Aktion Ã¼berschreibt alle aktuellen Daten!\n\n' +
            'Alle LehrkrÃ¤fte, Stockwerke und AufsichtsplÃ¤ne werden durch die Daten aus der Backup-Datei ersetzt.\n\n' +
            'MÃ¶chten Sie wirklich fortfahren?'
        );

        if (!confirmed) {
            return;
        }

        const formData = new FormData();
        formData.append('file', file);

        // Button deaktivieren und Loading-Status anzeigen
        const button = event.target;
        const originalText = button.innerHTML;
        button.innerHTML = 'â³ Wiederherstellen...';
        button.disabled = true;

        try {
            const response = await fetch('/backup/restore', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (response.ok) {
                alert('âœ… ' + result.message + '\n\nDie Seite wird neu geladen...');
                window.location.reload();
            } else {
                throw new Error(result.detail || 'Unbekannter Fehler');
            }
        } catch (error) {
            alert('âŒ Fehler beim Wiederherstellen: ' + error.message);

            // Button wieder aktivieren
            button.innerHTML = originalText;
            button.disabled = false;
        }
    }
</script>
{% endblock %}