<div id="planContainer">
    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="background: #f5f5f5;">
                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Tag</th>
                {% for label in break_labels %}
                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">{{ label }}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% if grid and day_labels and breaks_per_day %} {% for d_idx in range(0, 5) %}
            <tr>
                <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold; background: #f9f9f9;">
                    {{ day_labels[d_idx] }}
                </td>
                {% for b in range(0, breaks_per_day) %}
                <td class="drop-zone" data-day="{{ d_idx }}" data-break="{{ b }}" style="border: 1px solid #ddd; padding: 8px; vertical-align: top; min-height: 60px; position: relative;" ondrop="drop(event)" ondragover="allowDrop(event)" ondragleave="clearDropHighlight(event)"
                    ondragenter="handleDragEnter(event)">
                    {% for line in grid[d_idx][b] %} {% set outer_loop = loop %} {% for floor_line in [line] %} {% if ':' in floor_line %} {% set floor_name, teachers_str = floor_line.split(':', 1) %}
                    <div class="floor-container" style="margin: 2px 0; padding: 4px; border-left: 3px solid #3498db; background: #f8f9fa; border-radius: 3px;">
                        <strong>{{ floor_name.strip() }}:</strong>
                        <div class="teachers-container" style="margin-top: 2px;">
                            {% if teachers_str.strip() != '‚Äî' and teachers_str.strip() != '' %} {% for teacher in teachers_str.split(',') %} {% if teacher.strip() %}
                            <span class="teacher-chip" draggable="true" ondragstart="dragStart(event)" ondragend="dragEnd(event)" data-teacher="{{ teacher.strip() }}" data-floor="{{ floor_name.strip() }}" data-day="{{ d_idx }}" data-break="{{ b }}" style="display: inline-block; margin: 1px 2px; padding: 2px 6px; background: #e3f2fd; border: 1px solid #2196f3; border-radius: 12px; font-size: 0.9em; cursor: move; user-select: none;">
                                            {{ teacher.strip() }}
                                        </span> {% endif %} {% endfor %} {% else %}
                            <span style="color: #999; font-style: italic;">‚Äî</span> {% endif %}
                        </div>
                    </div>
                    {% endif %} {% endfor %} {% endfor %}
                </td>
                {% endfor %}
            </tr>
            {% endfor %} {% else %}
            <tr>
                <td colspan="{{ 1 + (break_labels|length if break_labels else 4) }}" style="border: 1px solid #ddd; padding: 8px; text-align: center; color: #666;">
                    Noch kein Plan vorhanden. Klicken Sie auf "Plan erzeugen".
                </td>
            </tr>
            {% endif %}
        </tbody>
    </table>
</div>

{% if grid and day_labels and breaks_per_day %}
<div id="editControls" style="margin-top: 1rem; padding: 1rem; background: #e8f5e8; border-radius: 5px; border-left: 4px solid #27ae60;">
    <h4 style="margin: 0 0 0.5rem 0; color: #27ae60;">‚úèÔ∏è Plan bearbeiten</h4>
    <p style="margin: 0 0 1rem 0; color: #555; font-size: 0.9rem;">
        <strong>üéØ Direktes Drag-and-Drop:</strong><br> ‚Ä¢ Klicken und ziehen Sie Lehrkr√§fte zwischen allen Stockwerken und Pausen<br> ‚Ä¢ Das Ziel-Stockwerk wird automatisch erkannt<br> ‚Ä¢ Einfach auf das gew√ºnschte Stockwerk ziehen und loslassen<br> ‚Ä¢ √Ñnderungen
        werden erst beim Speichern √ºbernommen
    </p>
    <button id="saveChanges" onclick="saveChanges()" style="padding: 0.6rem 1.2rem; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 0.5rem;" disabled>
        üíæ √Ñnderungen speichern
    </button>
    <button onclick="resetPlan()" style="padding: 0.6rem 1.2rem; background: #95a5a6; color: white; border: none; border-radius: 4px; cursor: pointer;">
        üîÑ Plan zur√ºcksetzen
    </button>
    <div id="changeStatus" style="margin-top: 0.5rem; font-size: 0.9rem; color: #666;"></div>
</div>

<script>
    let hasChanges = false;
    let draggedTeacher = null;

    function dragStart(event) {
        console.log('Drag Start Event:', event.target);

        draggedTeacher = {
            teacher: event.target.dataset.teacher,
            floor: event.target.dataset.floor,
            sourceDay: event.target.dataset.day,
            sourceBreak: event.target.dataset.break
        };

        console.log('Dragged Teacher Data:', draggedTeacher);

        if (!draggedTeacher.teacher || !draggedTeacher.floor) {
            console.error('Unvollst√§ndige Teacher-Daten beim Drag Start:', draggedTeacher);
            return;
        }

        event.target.style.opacity = '0.5';
        event.target.style.transform = 'scale(0.95)';

        // Highlight ALLE Drop-Zonen (alle Stockwerke und Pausen)
        document.querySelectorAll('.drop-zone').forEach(zone => {
            zone.style.background = '#f0f8ff';
            zone.style.border = '2px dashed #2196f3';
        });

        // Zus√§tzliches Highlight f√ºr Stockwerk-Container
        document.querySelectorAll('.floor-container').forEach(container => {
            container.style.border = '2px dashed #27ae60';
            container.style.background = '#f8fff8';
        });
    }

    function dragEnd(event) {
        event.target.style.opacity = '1';
        event.target.style.transform = 'scale(1)';

        // Reset alle Highlights
        document.querySelectorAll('.drop-zone').forEach(zone => {
            zone.style.background = '';
            zone.style.border = '1px solid #ddd';
        });

        // Reset Stockwerk-Container Highlights
        document.querySelectorAll('.floor-container').forEach(container => {
            container.style.border = '3px solid #3498db';
            container.style.background = '#f8f9fa';
        });
    }

    function allowDrop(event) {
        event.preventDefault();
        if (draggedTeacher) {
            // Alle Zonen sind jetzt g√ºltige Drop-Ziele
            const zone = event.currentTarget;
            zone.style.background = '#e8f5e8';
            zone.style.transform = 'scale(1.02)';
            zone.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';

            // Highlight das Stockwerk unter der Maus
            highlightTargetFloor(event);
        }
    }

    function handleDragEnter(event) {
        event.preventDefault();
        if (draggedTeacher) {
            const zone = event.currentTarget;
            zone.style.background = '#e8f5e8';
            zone.style.transform = 'scale(1.02)';
            zone.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
        }
    }

    function highlightTargetFloor(event) {
        // Entferne vorherige Floor-Highlights
        document.querySelectorAll('.floor-container').forEach(container => {
            container.style.border = '3px solid #3498db';
            container.style.background = '#f8f9fa';
        });

        // Finde das Stockwerk unter dem Mauszeiger
        const elementUnderMouse = document.elementFromPoint(event.clientX, event.clientY);
        let currentElement = elementUnderMouse;

        while (currentElement && !currentElement.classList.contains('floor-container')) {
            currentElement = currentElement.parentElement;
            if (!currentElement || currentElement.classList.contains('drop-zone')) break;
        }

        if (currentElement && currentElement.classList.contains('floor-container')) {
            currentElement.style.border = '3px solid #27ae60';
            currentElement.style.background = '#e8f5e8';
        }
    }

    function clearDropHighlight(event) {
        const zone = event.currentTarget;
        if (draggedTeacher) {
            zone.style.background = '#f0f8ff';
            zone.style.border = '2px dashed #2196f3';
        } else {
            zone.style.background = '';
            zone.style.border = '1px solid #ddd';
        }
        zone.style.transform = '';
        zone.style.boxShadow = '';
    }

    function drop(event) {
        event.preventDefault();
        console.log('Drop Event:', event.currentTarget, draggedTeacher);

        if (!draggedTeacher) {
            console.log('Kein draggedTeacher beim Drop');
            return;
        }

        const targetZone = event.currentTarget;
        const targetDay = targetZone.dataset.day;
        const targetBreak = targetZone.dataset.break;

        console.log('Drop Target:', {
            targetDay,
            targetBreak,
            sourceDay: draggedTeacher.sourceDay,
            sourceBreak: draggedTeacher.sourceBreak
        });

        // Pr√ºfe, ob es eine andere Position ist
        if (draggedTeacher.sourceDay === targetDay && draggedTeacher.sourceBreak === targetBreak) {
            console.log('Gleiche Position - Drop abgebrochen');
            resetDragState();
            return; // Gleiche Position
        }

        // Direktes Drop ohne Dialog
        console.log('F√ºhre Direct Drop aus');
        performDirectDrop(targetZone, targetDay, targetBreak, event);
    }

    function performDirectDrop(targetZone, targetDay, targetBreak, event) {
        // Bestimme das Ziel-Stockwerk basierend auf Drop-Position
        let targetFloorContainer = null;
        let targetFloorName = null;

        // Finde das Stockwerk unter dem Mauszeiger
        const elementUnderMouse = document.elementFromPoint(event.clientX, event.clientY);

        // Suche nach dem n√§chsten floor-container
        let currentElement = elementUnderMouse;
        while (currentElement && !currentElement.classList.contains('floor-container')) {
            currentElement = currentElement.parentElement;
            if (currentElement === targetZone) break;
        }

        if (currentElement && currentElement.classList.contains('floor-container')) {
            targetFloorContainer = currentElement;
            const strongElement = currentElement.querySelector('strong');
            if (strongElement) {
                targetFloorName = strongElement.textContent.replace(':', '').trim();
            }
        } else {
            // Fallback: Nehme das erste verf√ºgbare Stockwerk in der Zielzone
            const firstFloorContainer = targetZone.querySelector('.floor-container');
            if (firstFloorContainer) {
                targetFloorContainer = firstFloorContainer;
                const strongElement = firstFloorContainer.querySelector('strong');
                if (strongElement) {
                    targetFloorName = strongElement.textContent.replace(':', '').trim();
                }
            }
        }

        if (!targetFloorContainer || !targetFloorName) {
            console.error('Drag-Drop Error: Kein g√ºltiges Ziel-Stockwerk gefunden!', {
                targetFloorContainer,
                targetFloorName,
                elementUnderMouse,
                targetZone
            });
            showErrorMessage('Kein g√ºltiges Ziel-Stockwerk gefunden!');
            resetDragState();
            return;
        }

        // F√ºhre die Verschiebung durch
        executeTeacherMove(targetFloorContainer, targetDay, targetBreak, targetFloorName);
    }

    function showErrorMessage(message) {
        const messageDiv = document.createElement('div');
        messageDiv.textContent = message;
        messageDiv.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
            padding: 1rem;
            z-index: 1000;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        `;

        document.body.appendChild(messageDiv);

        setTimeout(() => {
            if (document.body.contains(messageDiv)) {
                document.body.removeChild(messageDiv);
            }
        }, 3000);
    }

    function executeTeacherMove(targetFloorContainer, targetDay, targetBreak, targetFloorName) {
        // Finde die urspr√ºngliche Lehrkraft-Chip
        const originalChip = document.querySelector(
            `[data-teacher="${draggedTeacher.teacher}"][data-floor="${draggedTeacher.floor}"][data-day="${draggedTeacher.sourceDay}"][data-break="${draggedTeacher.sourceBreak}"]`
        );

        if (!originalChip) {
            showErrorMessage('Urspr√ºngliche Lehrkraft nicht gefunden!');
            resetDragState();
            return;
        }

        // Entferne die Lehrkraft von der urspr√ºnglichen Position
        originalChip.remove();

        // Pr√ºfe, ob die urspr√ºngliche Position leer ist und f√ºge "‚Äî" hinzu
        const originalZone = document.querySelector(`[data-day="${draggedTeacher.sourceDay}"][data-break="${draggedTeacher.sourceBreak}"]`);
        if (originalZone) {
            originalZone.querySelectorAll('.floor-container').forEach(container => {
                const floorName = container.querySelector('strong').textContent.replace(':', '').trim();
                if (floorName === draggedTeacher.floor) {
                    const teachersContainer = container.querySelector('.teachers-container');
                    if (teachersContainer.querySelectorAll('.teacher-chip').length === 0) {
                        teachersContainer.innerHTML = '<span style="color: #999; font-style: italic;">‚Äî</span>';
                    }
                }
            });
        }

        // Erstelle neue Lehrkraft-Chip f√ºr die Zielposition
        const newChip = document.createElement('span');
        newChip.className = 'teacher-chip';
        newChip.draggable = true;
        newChip.ondragstart = dragStart;
        newChip.ondragend = dragEnd;
        newChip.dataset.teacher = draggedTeacher.teacher;
        newChip.dataset.floor = targetFloorName; // Wichtig: Neues Stockwerk setzen!
        newChip.dataset.day = targetDay;
        newChip.dataset.break = targetBreak;
        newChip.style.cssText = 'display: inline-block; margin: 1px 2px; padding: 2px 6px; background: #e3f2fd; border: 1px solid #2196f3; border-radius: 12px; font-size: 0.9em; cursor: move; user-select: none;';
        newChip.textContent = draggedTeacher.teacher;

        // F√ºge zur Zielposition hinzu
        const teachersContainer = targetFloorContainer.querySelector('.teachers-container');

        // Entferne "‚Äî" falls vorhanden
        const emptyIndicator = teachersContainer.querySelector('span[style*="italic"]');
        if (emptyIndicator) {
            emptyIndicator.remove();
        }

        teachersContainer.appendChild(newChip);

        // Animation f√ºr erfolgreiche Verschiebung
        newChip.style.background = '#d4edda';
        newChip.style.transform = 'scale(1.1)';
        setTimeout(() => {
            newChip.style.background = '#e3f2fd';
            newChip.style.transform = 'scale(1)';
        }, 500);

        // Markiere als ge√§ndert
        hasChanges = true;
        updateSaveButton();

        // Kurze Erfolgsmeldung
        showSuccessMessage(`${draggedTeacher.teacher} ‚Üí ${targetFloorName}`);

        resetDragState();
    }

    function resetDragState() {
        // Reset
        draggedTeacher = null;

        // Reset alle Highlights
        document.querySelectorAll('.drop-zone').forEach(zone => {
            zone.style.background = '';
            zone.style.border = '1px solid #ddd';
            zone.style.transform = '';
            zone.style.boxShadow = '';
        });

        // Reset Stockwerk-Container Highlights
        document.querySelectorAll('.floor-container').forEach(container => {
            container.style.border = '3px solid #3498db';
            container.style.background = '#f8f9fa';
        });
    }

    function showSuccessMessage(message) {
        const messageDiv = document.createElement('div');
        messageDiv.textContent = message;
        messageDiv.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            border-radius: 4px;
            padding: 1rem;
            z-index: 1000;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        `;

        document.body.appendChild(messageDiv);

        setTimeout(() => {
            if (document.body.contains(messageDiv)) {
                document.body.removeChild(messageDiv);
            }
        }, 3000);
    }

    function updateSaveButton() {
        const saveButton = document.getElementById('saveChanges');
        const statusDiv = document.getElementById('changeStatus');

        if (hasChanges) {
            saveButton.disabled = false;
            saveButton.style.background = '#e74c3c';
            saveButton.textContent = 'üíæ √Ñnderungen speichern (ungespeichert)';
            statusDiv.textContent = '‚ö†Ô∏è Sie haben ungespeicherte √Ñnderungen';
            statusDiv.style.color = '#e67e22';
        } else {
            saveButton.disabled = true;
            saveButton.style.background = '#27ae60';
            saveButton.textContent = 'üíæ √Ñnderungen speichern';
            statusDiv.textContent = '';
        }
    }

    function resetPlan() {
        if (hasChanges) {
            const confirmed = confirm('M√∂chten Sie wirklich alle √Ñnderungen verwerfen und den urspr√ºnglichen Plan wiederherstellen?');
            if (confirmed) {
                location.reload();
            }
        } else {
            location.reload();
        }
    }

    async function saveChanges() {
        if (!hasChanges) return;

        // Sammle alle aktuellen Zuweisungen
        const assignments = {};

        document.querySelectorAll('.drop-zone').forEach(zone => {
            const day = parseInt(zone.dataset.day);
            const breakIndex = parseInt(zone.dataset.break) + 1; // Backend erwartet 1-basierte Indices

            zone.querySelectorAll('.floor-container').forEach(floorContainer => {
                const floorName = floorContainer.querySelector('strong').textContent.replace(':', '').trim();
                const teachers = [];

                floorContainer.querySelectorAll('.teacher-chip').forEach(chip => {
                    teachers.push(chip.dataset.teacher);
                });

                const key = `${day}-${breakIndex}-${floorName}`;
                assignments[key] = {
                    day: day,
                    break_index: breakIndex,
                    floor: floorName,
                    teachers: teachers
                };
            });
        });

        // Speichere Button-Status
        const saveButton = document.getElementById('saveChanges');
        const originalText = saveButton.textContent;
        saveButton.textContent = '‚è≥ Speichere...';
        saveButton.disabled = true;

        try {
            const response = await fetch('/plan/save-changes', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    assignments: Object.values(assignments)
                })
            });

            if (response.ok) {
                hasChanges = false;
                updateSaveButton();
                saveButton.textContent = '‚úÖ Gespeichert';
                setTimeout(() => {
                    updateSaveButton();
                }, 2000);

                document.getElementById('changeStatus').textContent = '‚úÖ √Ñnderungen erfolgreich gespeichert';
                document.getElementById('changeStatus').style.color = '#27ae60';
                setTimeout(() => {
                    document.getElementById('changeStatus').textContent = '';
                }, 3000);
            } else {
                const error = await response.json();
                throw new Error(error.detail || 'Unbekannter Fehler');
            }
        } catch (error) {
            alert('‚ùå Fehler beim Speichern der √Ñnderungen: ' + error.message);
            saveButton.textContent = originalText;
            updateSaveButton();
        }
    }

    // Verhindere das Verlassen der Seite bei ungespeicherten √Ñnderungen
    window.addEventListener('beforeunload', function(e) {
        if (hasChanges) {
            e.preventDefault();
            e.returnValue = '';
        }
    });

    // Initialisierung der Drag-and-Drop-Funktionalit√§t
    function initializeDragAndDrop() {
        console.log('Initialisiere Drag-and-Drop-Funktionalit√§t');

        // Pr√ºfe alle Teacher-Chips
        const teacherChips = document.querySelectorAll('.teacher-chip');
        console.log('Gefundene Teacher-Chips:', teacherChips.length);

        teacherChips.forEach((chip, index) => {
            if (!chip.draggable) {
                console.warn(`Teacher-Chip ${index} ist nicht draggable:`, chip);
            }
            if (!chip.ondragstart) {
                console.warn(`Teacher-Chip ${index} hat keinen dragstart Handler:`, chip);
            }
        });

        // Pr√ºfe alle Drop-Zonen
        const dropZones = document.querySelectorAll('.drop-zone');
        console.log('Gefundene Drop-Zonen:', dropZones.length);

        dropZones.forEach((zone, index) => {
            if (!zone.ondrop) {
                console.warn(`Drop-Zone ${index} hat keinen drop Handler:`, zone);
            }
        });
    }

    // Initialisiere nach dem Laden
    document.addEventListener('DOMContentLoaded', initializeDragAndDrop);

    // Fallback f√ºr den Fall, dass DOMContentLoaded bereits gefeuert wurde
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeDragAndDrop);
    } else {
        initializeDragAndDrop();
    }

    // Hover-Effekte f√ºr bessere UX
    document.addEventListener('mouseover', function(e) {
        if (e.target.classList.contains('teacher-chip')) {
            e.target.style.background = '#bbdefb';
            e.target.style.transform = 'scale(1.05)';
        }
    });

    document.addEventListener('mouseout', function(e) {
        if (e.target.classList.contains('teacher-chip')) {
            e.target.style.background = '#e3f2fd';
            e.target.style.transform = 'scale(1)';
        }
    });
</script>
{% endif %}