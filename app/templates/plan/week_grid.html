<div id="planContainer">
    {% if teacher_options_json %}
    <script>
        window.teacherOptions = {{ teacher_options_json | safe }};
    </script>
    {% else %}
    <script>
        window.teacherOptions = window.teacherOptions || [];
    </script>
    {% endif %}
    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="background: #f5f5f5;">
                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Tag</th>
                {% for label in break_labels %}
                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">{{ label }}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% if grid and day_labels and breaks_per_day %} {% for d_idx in range(0, 5) %}
            <tr>
                <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold; background: #f9f9f9;">
                    {{ day_labels[d_idx] }}
                </td>
                {% for b in range(0, breaks_per_day) %}
                <td class="drop-zone" data-day="{{ d_idx }}" data-break="{{ b }}" style="border: 1px solid #ddd; padding: 8px; vertical-align: top; min-height: 60px; position: relative;" ondrop="drop(event)" ondragover="allowDrop(event)" ondragleave="clearDropHighlight(event)"
                    ondragenter="handleDragEnter(event)">
                    {% for line in grid[d_idx][b] %} {% set outer_loop = loop %} {% for floor_line in [line] %} {% if ':' in floor_line %} {% set floor_name, teachers_str = floor_line.split(':', 1) %}
                    <div class="floor-container" data-floor="{{ floor_name.strip() }}" data-day="{{ d_idx }}" data-break="{{ b }}" style="margin: 2px 0; padding: 4px; border-left: 3px solid #3498db; background: #f8f9fa; border-radius: 3px;">
                        <strong>{{ floor_name.strip() }}:</strong>
                        <div class="teachers-container" style="margin-top: 2px;">
                            {% if teachers_str.strip() != '‚Äî' and teachers_str.strip() != '' %}
                                {% for teacher in teachers_str.split(',') %}
                                    {% set teacher_raw = teacher.strip() %}
                                    {% if teacher_raw %}
                                        {% set parts = teacher_raw.split('|') %}
                                        {% set teacher_label = parts[0].strip() %}
                                        {% set teacher_warn = (parts|length > 1 and parts[1].strip() == 'warn') %}
                                        {% set chip_base_style = 'display: inline-flex; align-items: center; gap: 4px; margin: 1px 2px; padding: 2px 6px; border-radius: 12px; font-size: 0.9em; cursor: move; user-select: none;' %}
                                        {% if teacher_warn %}
                                            {% set chip_style = chip_base_style ~ ' background: #fdecea; border: 1px solid #e74c3c;' %}
                                        {% else %}
                                            {% set chip_style = chip_base_style ~ ' background: #e3f2fd; border: 1px solid #2196f3;' %}
                                        {% endif %}
                                        <span class="teacher-chip{% if teacher_warn %} teacher-chip-warn{% endif %}" draggable="true" ondragstart="dragStart(event)" ondragend="dragEnd(event)" data-teacher="{{ teacher_label }}" data-floor="{{ floor_name.strip() }}" data-day="{{ d_idx }}" data-break="{{ b }}" data-warning="{{ '1' if teacher_warn else '0' }}" style="{{ chip_style }}">
                                            <span class="teacher-chip-label">{{ teacher_label }}</span>
                                            {% if teacher_warn %}
                                                <span class="teacher-warning" title="Ohne Unterricht vor/nach der Pause eingeteilt" style="color: #e74c3c; font-weight: bold;">!</span>
                                            {% endif %}
                                            <button type="button" class="remove-teacher-btn" onclick="removeTeacher(event)" title="Lehrkraft entfernen" style="border: none; background: transparent; color: #c0392b; font-weight: bold; cursor: pointer; padding: 0; line-height: 1; font-size: 1rem;">√ó</button>
                                        </span>
                                    {% endif %}
                                {% endfor %}
                            {% else %}
                                <span class="teachers-empty-indicator" style="color: #999; font-style: italic;">‚Äî</span>
                            {% endif %}
                        </div>
                        <div class="add-teacher-actions" style="margin-top: 6px;">
                            <button type="button" class="add-teacher-btn" onclick="openAddTeacherDialog(event)" style="padding: 2px 6px; background: #27ae60; color: white; border: none; border-radius: 12px; font-size: 0.8rem; cursor: pointer;">
                                ‚ûï Lehrkraft hinzuf√ºgen
                            </button>
                        </div>
                    </div>
                    {% endif %} {% endfor %} {% endfor %}
                </td>
                {% endfor %}
            </tr>
            {% endfor %} {% else %}
            <tr>
                <td colspan="{{ 1 + (break_labels|length if break_labels else 4) }}" style="border: 1px solid #ddd; padding: 8px; text-align: center; color: #666;">
                    Noch kein Plan vorhanden. Klicken Sie auf "Plan erzeugen".
                </td>
            </tr>
            {% endif %}
        </tbody>
    </table>
</div>

{% if grid and day_labels and breaks_per_day %}
<div id="editControls" style="margin-top: 1rem; padding: 1rem; background: #e8f5e8; border-radius: 5px; border-left: 4px solid #27ae60;">
    <h4 style="margin: 0 0 0.5rem 0; color: #27ae60;">‚úèÔ∏è Plan bearbeiten</h4>
    <p style="margin: 0 0 1rem 0; color: #555; font-size: 0.9rem;">
        <strong>üéØ Direktes Drag-and-Drop:</strong><br> ‚Ä¢ Klicken und ziehen Sie Lehrkr√§fte zwischen allen Stockwerken und Pausen<br> ‚Ä¢ Das Ziel-Stockwerk wird automatisch erkannt<br> ‚Ä¢ Einfach auf das gew√ºnschte Stockwerk ziehen und loslassen<br> ‚Ä¢ √Ñnderungen
        werden erst beim Speichern √ºbernommen
    </p>
    <button id="saveChanges" onclick="saveChanges()" style="padding: 0.6rem 1.2rem; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 0.5rem;" disabled>
        üíæ √Ñnderungen speichern
    </button>
    <button onclick="resetPlan()" style="padding: 0.6rem 1.2rem; background: #95a5a6; color: white; border: none; border-radius: 4px; cursor: pointer;">
        üîÑ Plan zur√ºcksetzen
    </button>
    <div id="changeStatus" style="margin-top: 0.5rem; font-size: 0.9rem; color: #666;"></div>
</div>

<script>
    let hasChanges = false;
    let draggedTeacher = null;
    let activeAddDialog = null;

    const teacherOptions = Array.isArray(window.teacherOptions) ? window.teacherOptions : [];
    const TEACHER_CHIP_STYLE = 'display: inline-flex; align-items: center; gap: 4px; margin: 1px 2px; padding: 2px 6px; background: #e3f2fd; border: 1px solid #2196f3; border-radius: 12px; font-size: 0.9em; cursor: move; user-select: none;';
    const REMOVE_BUTTON_STYLE = 'border: none; background: transparent; color: #c0392b; font-weight: bold; cursor: pointer; padding: 0; line-height: 1; font-size: 1rem;';

    function getTeacherOption(value) {
        if (!value) {
            return null;
        }
        const normalized = value.toLowerCase();
        return teacherOptions.find(opt => {
            if (!opt) return false;
            const optionValue = (opt.value || '').toLowerCase();
            const optionDisplay = (opt.display || '').toLowerCase();
            const optionAbbrev = (opt.abbreviation || '').toLowerCase();
            if (optionValue === normalized) return true;
            if (optionDisplay === normalized) return true;
            if (optionAbbrev === normalized) return true;
            return false;
        }) || null;
    }

    function getTeacherDisplayName(value) {
        const option = getTeacherOption(value);
        if (option && option.display) {
            return option.display;
        }
        return value || '';
    }

    function removePlaceholder(container) {
        if (!container) {
            return;
        }
        const placeholder = container.querySelector('.teachers-empty-indicator');
        if (placeholder) {
            placeholder.remove();
        }
    }

    function ensurePlaceholder(container) {
        if (!container) {
            return;
        }
        if (container.querySelector('.teacher-chip')) {
            const existing = container.querySelector('.teachers-empty-indicator');
            if (existing) {
                existing.remove();
            }
            return;
        }
        if (!container.querySelector('.teachers-empty-indicator')) {
            const placeholder = document.createElement('span');
            placeholder.className = 'teachers-empty-indicator';
            placeholder.style.color = '#999';
            placeholder.style.fontStyle = 'italic';
            placeholder.textContent = '‚Äî';
            container.appendChild(placeholder);
        }
    }

    function createTeacherChip(teacherData, floorName, day, breakIndex) {
        const value = teacherData.value;
        const label = teacherData.label || value;
        const chip = document.createElement('span');
        chip.className = 'teacher-chip';
        chip.draggable = true;
        chip.dataset.teacher = value;
        chip.dataset.floor = floorName;
        chip.dataset.day = String(day);
        chip.dataset.break = String(breakIndex);
        chip.style.cssText = TEACHER_CHIP_STYLE;
        chip.ondragstart = dragStart;
        chip.ondragend = dragEnd;

        const labelSpan = document.createElement('span');
        labelSpan.className = 'teacher-chip-label';
        labelSpan.textContent = label;
        chip.appendChild(labelSpan);

        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'remove-teacher-btn';
        removeBtn.title = 'Lehrkraft entfernen';
        removeBtn.style.cssText = REMOVE_BUTTON_STYLE;
        removeBtn.textContent = '√ó';
        removeBtn.onclick = removeTeacher;
        chip.appendChild(removeBtn);

        return chip;
    }

    function animateChip(chip) {
        if (!chip) {
            return;
        }
        chip.style.background = '#d4edda';
        chip.style.transform = 'scale(1.1)';
        setTimeout(() => {
            chip.style.background = '#e3f2fd';
            chip.style.transform = 'scale(1)';
        }, 500);
    }

    function ensureTeacherOptionsDatalist() {
        const datalistId = 'teacherOptionsList';
        let datalist = document.getElementById(datalistId);
        if (!datalist) {
            datalist = document.createElement('datalist');
            datalist.id = datalistId;
            document.body.appendChild(datalist);
        }

        if (!datalist.dataset.populated) {
            datalist.innerHTML = '';
            teacherOptions.forEach(opt => {
                if (!opt) return;
                const option = document.createElement('option');
                option.value = opt.value;
                if (opt.display && opt.display !== opt.value) {
                    option.label = opt.display;
                }
                datalist.appendChild(option);
            });
            datalist.dataset.populated = 'true';
        }
        return datalist;
    }

    function closeAddTeacherDialog() {
        if (activeAddDialog && activeAddDialog.parentElement) {
            activeAddDialog.parentElement.removeChild(activeAddDialog);
        }
        activeAddDialog = null;
    }

    function handleAddTeacherConfirm(floorContainer, day, breakIndex, rawValue) {
        if (!rawValue) {
            showErrorMessage('Bitte eine Lehrkraft ausw√§hlen.');
            return;
        }

        const option = getTeacherOption(rawValue.trim());
        if (!option) {
            showErrorMessage(`Lehrkraft "${rawValue}" nicht gefunden.`);
            return;
        }

        const success = addTeacherToContainer(floorContainer, day, breakIndex, option);
        if (success) {
            closeAddTeacherDialog();
        }
    }

    function addTeacherToContainer(floorContainer, day, breakIndex, option) {
        const teachersContainer = floorContainer.querySelector('.teachers-container');
        if (!teachersContainer) {
            showErrorMessage('Fehler: Zielbereich nicht gefunden.');
            return false;
        }

        const teacherValue = option.value;

        const alreadyAssigned = Array.from(teachersContainer.querySelectorAll('.teacher-chip')).some(chip => chip.dataset.teacher === teacherValue);
        if (alreadyAssigned) {
            showErrorMessage(`${getTeacherDisplayName(teacherValue)} ist bereits zugewiesen.`);
            return false;
        }

        removePlaceholder(teachersContainer);

        const chip = createTeacherChip({ value: teacherValue, label: option.value }, floorContainer.dataset.floor, day, breakIndex);
        teachersContainer.appendChild(chip);
        animateChip(chip);

        hasChanges = true;
        updateSaveButton();
        showSuccessMessage(`${getTeacherDisplayName(teacherValue)} ‚Üí ${floorContainer.dataset.floor}`);
        return true;
    }

    function openAddTeacherDialog(event) {
        event.stopPropagation();

        if (!teacherOptions.length) {
            showErrorMessage('Keine Lehrkr√§fte verf√ºgbar. Bitte zuerst Lehrkr√§fte importieren.');
            return;
        }

        const button = event.currentTarget;
        const floorContainer = button.closest('.floor-container');
        if (!floorContainer) {
            return;
        }

        if (activeAddDialog && activeAddDialog.parentElement === floorContainer) {
            closeAddTeacherDialog();
            return;
        }

        closeAddTeacherDialog();

        const datalist = ensureTeacherOptionsDatalist();

        const dialog = document.createElement('div');
        dialog.className = 'add-teacher-dialog';
        dialog.style.cssText = 'margin-top: 6px; background: #ffffff; border: 1px solid #27ae60; border-radius: 6px; padding: 8px; display: flex; gap: 6px; flex-wrap: wrap; align-items: center;';

        const input = document.createElement('input');
        input.type = 'text';
        input.placeholder = 'K√ºrzel oder Name';
        input.style.cssText = 'flex: 1; min-width: 160px; padding: 4px 6px; border: 1px solid #ccc; border-radius: 4px;';
        input.setAttribute('list', datalist.id);

        const confirmButton = document.createElement('button');
        confirmButton.type = 'button';
        confirmButton.textContent = 'Hinzuf√ºgen';
        confirmButton.style.cssText = 'padding: 4px 8px; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer;';
        confirmButton.addEventListener('click', () => {
            handleAddTeacherConfirm(floorContainer, floorContainer.dataset.day, floorContainer.dataset.break, input.value.trim());
        });

        const cancelButton = document.createElement('button');
        cancelButton.type = 'button';
        cancelButton.textContent = 'Abbrechen';
        cancelButton.style.cssText = 'padding: 4px 8px; background: #95a5a6; color: white; border: none; border-radius: 4px; cursor: pointer;';
        cancelButton.addEventListener('click', () => {
            closeAddTeacherDialog();
        });

        dialog.appendChild(input);
        dialog.appendChild(confirmButton);
        dialog.appendChild(cancelButton);

        floorContainer.appendChild(dialog);
        activeAddDialog = dialog;

        setTimeout(() => {
            input.focus();
        }, 0);
    }

    function removeTeacher(event) {
        event.preventDefault();
        event.stopPropagation();

        const button = event.currentTarget;
        const chip = button.closest('.teacher-chip');
        if (!chip) {
            return;
        }

        const teachersContainer = chip.closest('.teachers-container');
        const teacherValue = chip.dataset.teacher;
        const floorName = chip.dataset.floor;

        chip.remove();
        ensurePlaceholder(teachersContainer);

        hasChanges = true;
        updateSaveButton();
        showSuccessMessage(`${getTeacherDisplayName(teacherValue)} von ${floorName} entfernt`);
    }

    function dragStart(event) {
        closeAddTeacherDialog();

        draggedTeacher = {
            teacher: event.target.dataset.teacher,
            floor: event.target.dataset.floor,
            sourceDay: event.target.dataset.day,
            sourceBreak: event.target.dataset.break,
        };
        draggedTeacher.display = event.target.querySelector('.teacher-chip-label')?.textContent?.trim() || getTeacherDisplayName(draggedTeacher.teacher);

        if (!draggedTeacher.teacher || !draggedTeacher.floor) {
            console.error('Unvollst√§ndige Teacher-Daten beim Drag Start:', draggedTeacher);
            return;
        }

        event.target.style.opacity = '0.5';
        event.target.style.transform = 'scale(0.95)';

        // Highlight ALLE Drop-Zonen (alle Stockwerke und Pausen)
        document.querySelectorAll('.drop-zone').forEach(zone => {
            zone.style.background = '#f0f8ff';
            zone.style.border = '2px dashed #2196f3';
        });

        // Zus√§tzliches Highlight f√ºr Stockwerk-Container
        document.querySelectorAll('.floor-container').forEach(container => {
            container.style.border = '2px dashed #27ae60';
            container.style.background = '#f8fff8';
        });
    }

    function dragEnd(event) {
        event.target.style.opacity = '1';
        event.target.style.transform = 'scale(1)';

        // Reset alle Highlights
        document.querySelectorAll('.drop-zone').forEach(zone => {
            zone.style.background = '';
            zone.style.border = '1px solid #ddd';
        });

        // Reset Stockwerk-Container Highlights
        document.querySelectorAll('.floor-container').forEach(container => {
            container.style.border = '3px solid #3498db';
            container.style.background = '#f8f9fa';
        });
    }

    function allowDrop(event) {
        event.preventDefault();
        if (draggedTeacher) {
            // Alle Zonen sind jetzt g√ºltige Drop-Ziele
            const zone = event.currentTarget;
            zone.style.background = '#e8f5e8';
            zone.style.transform = 'scale(1.02)';
            zone.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';

            // Highlight das Stockwerk unter der Maus
            highlightTargetFloor(event);
        }
    }

    function handleDragEnter(event) {
        event.preventDefault();
        if (draggedTeacher) {
            const zone = event.currentTarget;
            zone.style.background = '#e8f5e8';
            zone.style.transform = 'scale(1.02)';
            zone.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
        }
    }

    function highlightTargetFloor(event) {
        // Entferne vorherige Floor-Highlights
        document.querySelectorAll('.floor-container').forEach(container => {
            container.style.border = '3px solid #3498db';
            container.style.background = '#f8f9fa';
        });

        // Finde das Stockwerk unter dem Mauszeiger
        const elementUnderMouse = document.elementFromPoint(event.clientX, event.clientY);
        let currentElement = elementUnderMouse;

        while (currentElement && !currentElement.classList.contains('floor-container')) {
            currentElement = currentElement.parentElement;
            if (!currentElement || currentElement.classList.contains('drop-zone')) break;
        }

        if (currentElement && currentElement.classList.contains('floor-container')) {
            currentElement.style.border = '3px solid #27ae60';
            currentElement.style.background = '#e8f5e8';
        }
    }

    function clearDropHighlight(event) {
        const zone = event.currentTarget;
        if (draggedTeacher) {
            zone.style.background = '#f0f8ff';
            zone.style.border = '2px dashed #2196f3';
        } else {
            zone.style.background = '';
            zone.style.border = '1px solid #ddd';
        }
        zone.style.transform = '';
        zone.style.boxShadow = '';
    }

    function drop(event) {
        event.preventDefault();
        if (!draggedTeacher) {
            return;
        }

        const targetZone = event.currentTarget;
        const targetDay = targetZone.dataset.day;
        const targetBreak = targetZone.dataset.break;

        // Bestimme zun√§chst das Ziel-Stockwerk f√ºr den Vergleich
        let targetFloorName = null;
        const elementUnderMouse = document.elementFromPoint(event.clientX, event.clientY);
        let currentElement = elementUnderMouse;
        while (currentElement && !currentElement.classList.contains('floor-container')) {
            currentElement = currentElement.parentElement;
            if (currentElement === targetZone) break;
        }

        if (currentElement && currentElement.classList.contains('floor-container')) {
            targetFloorName = currentElement.dataset.floor || currentElement.querySelector('strong')?.textContent.replace(':', '').trim();
        } else {
            // Fallback: Nehme das erste verf√ºgbare Stockwerk in der Zielzone
            const firstFloorContainer = targetZone.querySelector('.floor-container');
            if (firstFloorContainer) {
                targetFloorName = firstFloorContainer.dataset.floor || firstFloorContainer.querySelector('strong')?.textContent.replace(':', '').trim();
            }
        }

        // Pr√ºfe, ob es WIRKLICH die gleiche Position ist (Tag, Pause UND Stockwerk)
        if (draggedTeacher.sourceDay === targetDay &&
            draggedTeacher.sourceBreak === targetBreak &&
            draggedTeacher.floor === targetFloorName) {
            resetDragState();
            return; // Exakt gleiche Position
        }

        performDirectDrop(targetZone, targetDay, targetBreak, event);
    }

    function performDirectDrop(targetZone, targetDay, targetBreak, event) {
        // Bestimme das Ziel-Stockwerk basierend auf Drop-Position
        let targetFloorContainer = null;
        let targetFloorName = null;

        // Finde das Stockwerk unter dem Mauszeiger
        const elementUnderMouse = document.elementFromPoint(event.clientX, event.clientY);

        // Suche nach dem n√§chsten floor-container
        let currentElement = elementUnderMouse;
        while (currentElement && !currentElement.classList.contains('floor-container')) {
            currentElement = currentElement.parentElement;
            if (currentElement === targetZone) break;
        }

        if (currentElement && currentElement.classList.contains('floor-container')) {
            targetFloorContainer = currentElement;
        } else {
            // Fallback: Nehme das erste verf√ºgbare Stockwerk in der Zielzone
            const firstFloorContainer = targetZone.querySelector('.floor-container');
            if (firstFloorContainer) {
                targetFloorContainer = firstFloorContainer;
            }
        }

        if (targetFloorContainer) {
            targetFloorName = targetFloorContainer.dataset.floor || targetFloorContainer.querySelector('strong')?.textContent.replace(':', '').trim();
        }

        if (!targetFloorContainer || !targetFloorName) {
            console.error('Drag-Drop Error: Kein g√ºltiges Ziel-Stockwerk gefunden!', {
                targetFloorContainer,
                targetFloorName,
                elementUnderMouse,
                targetZone
            });
            showErrorMessage('Kein g√ºltiges Ziel-Stockwerk gefunden!');
            resetDragState();
            return;
        }

        // F√ºhre die Verschiebung durch
        executeTeacherMove(targetFloorContainer, targetDay, targetBreak, targetFloorName);
    }

    function showErrorMessage(message) {
        const messageDiv = document.createElement('div');
        messageDiv.textContent = message;
        messageDiv.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
            padding: 1rem;
            z-index: 1000;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        `;

        document.body.appendChild(messageDiv);

        setTimeout(() => {
            if (document.body.contains(messageDiv)) {
                document.body.removeChild(messageDiv);
            }
        }, 3000);
    }

    function executeTeacherMove(targetFloorContainer, targetDay, targetBreak, targetFloorName) {
        const selector = `[data-teacher="${draggedTeacher.teacher}"][data-floor="${draggedTeacher.floor}"][data-day="${draggedTeacher.sourceDay}"][data-break="${draggedTeacher.sourceBreak}"]`;
        const originalChip = document.querySelector(selector);

        if (!originalChip) {
            showErrorMessage('Urspr√ºngliche Lehrkraft nicht gefunden!');
            resetDragState();
            return;
        }

        const sourceTeachersContainer = originalChip.closest('.teachers-container');
        originalChip.remove();
        ensurePlaceholder(sourceTeachersContainer);

        const teachersContainer = targetFloorContainer.querySelector('.teachers-container');
        if (!teachersContainer) {
            showErrorMessage('Zielbereich nicht gefunden.');
            resetDragState();
            return;
        }

        removePlaceholder(teachersContainer);

        const chip = createTeacherChip(
            { value: draggedTeacher.teacher, label: draggedTeacher.display || draggedTeacher.teacher },
            targetFloorName,
            targetDay,
            targetBreak
        );
        teachersContainer.appendChild(chip);
        animateChip(chip);

        hasChanges = true;
        updateSaveButton();
        showSuccessMessage(`${draggedTeacher.display || draggedTeacher.teacher} ‚Üí ${targetFloorName}`);

        resetDragState();
    }

    function resetDragState() {
        // Reset
        draggedTeacher = null;

        // Reset alle Highlights
        document.querySelectorAll('.drop-zone').forEach(zone => {
            zone.style.background = '';
            zone.style.border = '1px solid #ddd';
            zone.style.transform = '';
            zone.style.boxShadow = '';
        });

        // Reset Stockwerk-Container Highlights
        document.querySelectorAll('.floor-container').forEach(container => {
            container.style.border = '3px solid #3498db';
            container.style.background = '#f8f9fa';
        });
    }

    function showSuccessMessage(message) {
        const messageDiv = document.createElement('div');
        messageDiv.textContent = message;
        messageDiv.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            border-radius: 4px;
            padding: 1rem;
            z-index: 1000;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        `;

        document.body.appendChild(messageDiv);

        setTimeout(() => {
            if (document.body.contains(messageDiv)) {
                document.body.removeChild(messageDiv);
            }
        }, 3000);
    }

    function updateSaveButton() {
        const saveButton = document.getElementById('saveChanges');
        const statusDiv = document.getElementById('changeStatus');

        if (hasChanges) {
            saveButton.disabled = false;
            saveButton.style.background = '#e74c3c';
            saveButton.textContent = 'üíæ √Ñnderungen speichern (ungespeichert)';
            statusDiv.textContent = '‚ö†Ô∏è Sie haben ungespeicherte √Ñnderungen';
            statusDiv.style.color = '#e67e22';
        } else {
            saveButton.disabled = true;
            saveButton.style.background = '#27ae60';
            saveButton.textContent = 'üíæ √Ñnderungen speichern';
            statusDiv.textContent = '';
        }
    }

    function resetPlan() {
        if (hasChanges) {
            const confirmed = confirm('M√∂chten Sie wirklich alle √Ñnderungen verwerfen und den urspr√ºnglichen Plan wiederherstellen?');
            if (confirmed) {
                location.reload();
            }
        } else {
            location.reload();
        }
    }

    async function saveChanges() {
        if (!hasChanges) return;

        // Sammle alle aktuellen Zuweisungen
        const assignments = {};

        document.querySelectorAll('.drop-zone').forEach(zone => {
            const day = parseInt(zone.dataset.day);
            const breakIndex = parseInt(zone.dataset.break) + 1; // Backend erwartet 1-basierte Indices

            zone.querySelectorAll('.floor-container').forEach(floorContainer => {
                const floorName = floorContainer.querySelector('strong').textContent.replace(':', '').trim();
                const teachers = [];

                floorContainer.querySelectorAll('.teacher-chip').forEach(chip => {
                    teachers.push(chip.dataset.teacher);
                });

                const key = `${day}-${breakIndex}-${floorName}`;
                assignments[key] = {
                    day: day,
                    break_index: breakIndex,
                    floor: floorName,
                    teachers: teachers
                };
            });
        });

        // Speichere Button-Status
        const saveButton = document.getElementById('saveChanges');
        const originalText = saveButton.textContent;
        saveButton.textContent = '‚è≥ Speichere...';
        saveButton.disabled = true;

        try {
            const response = await fetch('/plan/save-changes', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    assignments: Object.values(assignments)
                })
            });

            if (response.ok) {
                hasChanges = false;
                updateSaveButton();
                saveButton.textContent = '‚úÖ Gespeichert';
                setTimeout(() => {
                    updateSaveButton();
                }, 2000);

                document.getElementById('changeStatus').textContent = '‚úÖ √Ñnderungen erfolgreich gespeichert';
                document.getElementById('changeStatus').style.color = '#27ae60';
                setTimeout(() => {
                    document.getElementById('changeStatus').textContent = '';
                }, 3000);
            } else {
                const error = await response.json();
                throw new Error(error.detail || 'Unbekannter Fehler');
            }
        } catch (error) {
            alert('‚ùå Fehler beim Speichern der √Ñnderungen: ' + error.message);
            saveButton.textContent = originalText;
            updateSaveButton();
        }
    }

    // Verhindere das Verlassen der Seite bei ungespeicherten √Ñnderungen
    window.addEventListener('beforeunload', function(e) {
        if (hasChanges) {
            e.preventDefault();
            e.returnValue = '';
        }
    });

    // Initialisierung der Drag-and-Drop-Funktionalit√§t
    function initializeDragAndDrop() {
        ensureTeacherOptionsDatalist();
    }

    // Initialisiere nach dem Laden
    document.addEventListener('DOMContentLoaded', initializeDragAndDrop);

    // Fallback f√ºr den Fall, dass DOMContentLoaded bereits gefeuert wurde
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeDragAndDrop);
    } else {
        initializeDragAndDrop();
    }

    // Hover-Effekte f√ºr bessere UX
    document.addEventListener('mouseover', function(e) {
        const chip = e.target.closest('.teacher-chip');
        if (!chip) {
            return;
        }
        chip.style.background = '#bbdefb';
        chip.style.transform = 'scale(1.05)';
    });

    document.addEventListener('mouseout', function(e) {
        const chip = e.target.closest('.teacher-chip');
        if (!chip) {
            return;
        }
        if (chip.contains(e.relatedTarget)) {
            return;
        }
        chip.style.background = '#e3f2fd';
        chip.style.transform = 'scale(1)';
    });

    document.addEventListener('click', function(e) {
        if (!activeAddDialog) {
            return;
        }
        if (activeAddDialog.contains(e.target)) {
            return;
        }
        if (e.target.closest('.add-teacher-btn')) {
            return;
        }
        closeAddTeacherDialog();
    });
</script>
{% endif %}
